apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "s3er.fullname" . }}-app-files
  labels:
    {{- include "s3er.labels" . | nindent 4 }}
data:
  entrypoint.sh: |
    pip install -r /app/requirements.txt
    python /app/poc.py
    #python /app/main.py

  requirements.txt: |
    boto3

  poc.py: |
    import os
    import time
    from random import randint

    print("welcome!")
    while True:
      sleep_seconds = randint(8, 32)
      print(f"sleeping for {str(sleep_seconds)} seconds!")
      time.sleep(sleep_seconds)

  main.py: |
    import boto3
    import os
    from time import sleep,time

    # configuration
    bucket_name = os.environ["BUCKET_NAME"]
    try:
      sleep_seconds = os.environ["SLEEP_SECONDS_OVERRIDE"]
    except KeyError:
      sleep_seconds = 8

    # define functions
    def ls_bucket(bucket_name):
      response = s3.list_objects(Bucket=bucket_name)
      if "Contents" in response.keys():
        return [object["Key"] for object in response["Contents"]]
      else:
        return []

    def main():
      i = 0
      while True:
        i += 1
        print(f"\n---- iteration {i} ----")
        object_key = f"demofile{i}.txt"
        object_body = f"written at {str(round(time()))}"

        # upload
        print(f"uploading object '{bucket_name}/{object_key}'...")
        print(f"{s3.put_object(Bucket=bucket_name, Key=object_key, Body=object_body)['ResponseMetadata']['HTTPStatusCode']}!")
        print(f"bucket '{bucket_name}' contents: {ls_bucket(bucket_name)}")

        # sleep
        print(f"sleeping for {sleep_seconds} seconds...")
        sleep(sleep_seconds)

        # remove
        print(f"removing object '{bucket_name}/{object_key}'...")
        print(f"{s3.delete_object(Bucket=bucket_name, Key=object_key)['ResponseMetadata']['HTTPStatusCode']}!")
        print(f"bucket '{bucket_name}' contents: {ls_bucket(bucket_name)}")

    if __name__ == "__main__":
      # s3 init
      s3 = boto3.client("s3")

      # verify bucket exists
      try:
        s3.head_bucket(Bucket=bucket_name)["ResponseMetadata"]["HTTPStatusCode"]
      except:
        print("ERROR: bucket doesn't exist!")
        print("quitting...")
        exit(1)

      main()
